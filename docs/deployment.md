# Deployment Guide
<!-- last-verified: 2026-02-15 -->

## Infrastructure (Render)

Deployed on Render (migrated from Railway on 2026-02-01).

| Service | Type | Name |
|---------|------|------|
| Backend | Web Service (Docker) | `parlo-backend` |
| Frontend | Web Service (Node) | `parlo-frontend` |
| Database | Render PostgreSQL | `parlo-db` |
| Redis | Not deployed | Celery workers deferred to save costs |

### Service IDs (Production)
- Backend: `srv-d6600q95pdvs73e3bft0`
- Frontend: `srv-d6600h95pdvs73e3bavg`
- Postgres: `dpg-d6600h95pdvs73e3bb2g-a`

### Configuration File
Use `render.yaml` (Infrastructure as Code) to deploy all services at once via Render Dashboard → New → Blueprint.

## Backend (FastAPI/Python)

1. **DATABASE_URL format**: Render provides `postgresql://...` via `fromDatabase` — the app automatically adds `+asyncpg` driver
2. **Use start.sh script**: Chaining commands with `&&` in Dockerfile CMD can fail silently. Use a bash script with `set -e` and explicit logging
3. **All env vars required**: Missing `OPENAI_API_KEY`, `JWT_SECRET_KEY` will crash silently — no error in logs
4. **pip install**: Use `pip install .` not `pip install -e .` in Docker (editable mode needs source)
5. **Health check**: Configure `/health` endpoint in Render for monitoring

## Frontend (Next.js)

1. **Use Node runtime**: Set `runtime: node` in render.yaml, not Docker
2. **Root directory**: Set `rootDir: frontend` for monorepo structure
3. **Build command**: `npm install && npm run build`
4. **Start command**: `npm run start`

## Monorepo Setup

- Backend and frontend are separate Render services from the same repo
- Backend uses Docker runtime (root Dockerfile)
- Frontend uses Node runtime with `rootDir: frontend`
- **.gitignore `lib/` trap**: Using `lib/` ignores `frontend/src/lib/`. Use `/lib/` (with leading slash) to only match root level

## Environment Variables

### Backend `.env`
```bash
APP_ENV=development  # development, staging, production
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/parlo
REDIS_URL=redis://localhost:6379/0
OPENAI_API_KEY=sk-...
TWILIO_ACCOUNT_SID=...
TWILIO_AUTH_TOKEN=...
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886
JWT_SECRET_KEY=change-in-production
FRONTEND_URL=http://localhost:3000
ADMIN_MASTER_PASSWORD=change-in-production
```

### Frontend `.env.local`
```bash
NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
NEXT_PUBLIC_PARLO_WHATSAPP_NUMBER=17759674528
```

### Backend (Production on Render)
```
DATABASE_URL=<from render postgres>  # Auto-configured via fromDatabase
REDIS_URL=""                         # Empty - not using Redis
OPENAI_API_KEY=sk-...               # Set manually in dashboard
JWT_SECRET_KEY=<auto-generated>
ADMIN_MASTER_PASSWORD=<set manually>
FRONTEND_URL=https://parlo-frontend.onrender.com
APP_ENV=production
```

### Frontend (Production on Render)
```
NEXT_PUBLIC_API_URL=https://parlo-backend.onrender.com/api/v1
```

## URLs

### Production
- Backend: `https://parlo-backend.onrender.com`
- Frontend: `https://parlo-frontend.onrender.com`
- Admin Dashboard: `https://parlo-frontend.onrender.com/admin`

### Staging
- Backend: `https://parlo-staging-backend.onrender.com`
- Frontend: `https://parlo-staging-frontend.onrender.com`
- Admin + Simulate: `https://parlo-staging-frontend.onrender.com/admin/simulate`
- Blueprint file: `render-staging.yaml` (auto-deploys from `staging` branch)
- Seed script: `python scripts/seed_staging.py` (run against staging DB)

## Git Workflow

```
feature-branch → PR to staging → CI passes → merge → staging auto-deploys
                                                       ↓
                                              validate on staging
                                                       ↓
                                    staging → PR to main → CI passes → merge → production auto-deploys
```

- CI runs on push/PR to both `main` and `staging` branches
- Evals can be triggered manually via GitHub Actions (`evals.yml` workflow_dispatch)

## Render CLI

- Load RENDER_API_KEY from .env before running render commands: `export $(grep RENDER_API_KEY .env | xargs)`
- Use `--output json --confirm` for non-interactive mode
- Key commands: `render services`, `render deploys list`, `render logs`, `render deploys create`
